<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOSERS | –ü–æ–∏—Å–∫ –∏ –∑–∞–∫–∞–∑ —Å POIZON</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ========== –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #ffffff;
            color: #1a1a1a;
            padding: 0 12px 80px 12px;
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #f8f8f8;
                color: #1a1a1a;
            }
        }
        
        .app {
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* ========== –•–ï–î–ï–† ========== */
        .header {
            padding: 20px 0 12px 0;
            margin-bottom: 16px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #000000;
            margin-bottom: 4px;
        }
        
        .subtitle {
            color: #8e8e93;
            font-size: 14px;
            font-weight: 400;
        }
        
        /* ========== –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (–∫–∞–∫ –≤ UNICORN) ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-around;
            padding: 8px 16px 20px 16px;
            max-width: 600px;
            margin: 0 auto;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            font-size: 11px;
            color: #8e8e93;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s;
            gap: 4px;
        }
        
        .nav-item.active {
            color: #000000;
            font-weight: 500;
        }
        
        .nav-icon {
            font-size: 22px;
            line-height: 1;
        }
        
        #cart-badge {
            background-color: #000000;
            color: #ffffff;
            border-radius: 20px;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 2px;
        }
        
        /* ========== –ö–ê–¢–ê–õ–û–ì (3 –ö–û–õ–û–ù–ö–ò) ========== */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 20px 0 12px 0;
        }
        
        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .product-card {
            background-color: #f9f9f9;
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .product-card.in-cart {
            border-color: #000000;
            background-color: #f5f5f5;
        }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1/1;
            background-color: #e8e8e8;
            border-radius: 8px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999999;
            font-size: 10px;
            font-weight: 500;
        }
        
        .product-title {
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 2px;
            line-height: 1.2;
            height: 26px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            color: #333;
        }
        
        .product-price {
            font-size: 12px;
            font-weight: 600;
            color: #000000;
        }
        
        .cart-badge-mini {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #000000;
            color: #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–í–´–ë–û–† –†–ê–ó–ú–ï–†–ê) ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-product-preview {
            margin-bottom: 16px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 12px;
        }
        
        .modal-product-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        /* ========== –§–û–†–ú–´ ========== */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #ffffff;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #000000;
        }
        
        /* ========== –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û ========== */
        .photo-upload-area {
            border: 1px dashed #c0c0c0;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
            cursor: pointer;
            background-color: #f9f9f9;
        }
        
        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 12px 0;
        }
        
        .photo-preview-item {
            position: relative;
            aspect-ratio: 1/1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* ========== –ö–û–†–ó–ò–ù–ê ========== */
        .cart-container {
            background-color: #f9f9f9;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px;
            background-color: #ffffff;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid #f0f0f0;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .cart-item-details {
            font-size: 12px;
            color: #666;
            white-space: pre-line;
        }
        
        .cart-item-thumb {
            width: 50px;
            height: 50px;
            background-color: #f0f0f0;
            border-radius: 6px;
            margin-right: 12px;
            object-fit: cover;
        }
        
        .cart-item-remove {
            background: none;
            border: none;
            color: #999;
            font-size: 18px;
            cursor: pointer;
        }
        
        /* ========== –ó–ê–ö–ê–ó–´ –ò –°–¢–ê–¢–£–°–´ ========== */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .order-card {
            background-color: #f9f9f9;
            border-radius: 16px;
            padding: 16px;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .order-id {
            font-weight: 700;
            font-size: 15px;
        }
        
        .order-status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            background-color: #f0f0f0;
        }
        
        /* –¢—Ä–µ–∫–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ */
        .status-timeline {
            margin: 16px 0;
            position: relative;
        }
        
        .status-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            position: relative;
        }
        
        .status-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #e0e0e0;
            margin-right: 12px;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
        }
        
        .status-dot.completed {
            background-color: #000000;
        }
        
        .status-dot.active {
            background-color: #000000;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        
        .status-line {
            position: absolute;
            left: 9px;
            top: 20px;
            width: 2px;
            height: calc(100% - 8px);
            background-color: #e0e0e0;
            z-index: 1;
        }
        
        .status-content {
            flex: 1;
            padding-bottom: 12px;
        }
        
        .status-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .status-date {
            font-size: 11px;
            color: #999;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background-color: #000000;
            color: #ffffff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #000000;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 13px;
            background-color: #f0f0f0;
            color: #000000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .support-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: #000000;
            color: #ffffff;
            text-decoration: none;
            border-radius: 30px;
            font-size: 13px;
        }
        
        .loading {
            text-align: center;
            color: #999;
            padding: 40px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- –•–µ–¥–µ—Ä -->
        <header class="header">
            <h1>CLOSERS</h1>
            <div class="subtitle">–ü–û–ò–°–ö –ò –ó–ê–ö–ê–ó –° POIZON</div>
        </header>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ (–º–µ–Ω—è–µ–º —á–µ—Ä–µ–∑ JS) -->
        <div id="catalog-view">
            <!-- –ö–∞—Ç–∞–ª–æ–≥ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <div id="cart-view" style="display: none;">
            <!-- –ö–æ—Ä–∑–∏–Ω–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <div id="orders-view" style="display: none;">
            <!-- –ó–∞–∫–∞–∑—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
        <div id="product-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</div>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                
                <div id="modal-product" class="modal-product-preview"></div>
                
                <div class="form-group">
                    <label>–†–ê–ó–ú–ï–†</label>
                    <select id="modal-size">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                        <option value="36">36 EU</option>
                        <option value="37">37 EU</option>
                        <option value="38">38 EU</option>
                        <option value="39">39 EU</option>
                        <option value="40">40 EU</option>
                        <option value="41">41 EU</option>
                        <option value="42">42 EU</option>
                        <option value="43">43 EU</option>
                        <option value="44">44 EU</option>
                        <option value="45">45 EU</option>
                        <option value="46">46 EU</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–¶–í–ï–¢ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="modal-color" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Black/White">
                </div>
                
                <div class="form-group">
                    <label>–ß–¢–û –ò–©–ï–¢–ï?</label>
                    <input type="text" id="modal-query" placeholder="–°—Å—ã–ª–∫–∞, –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                </div>
                
                <!-- –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û -->
                <div class="form-group">
                    <label>–§–û–¢–û (–¥–æ 5 —à—Ç)</label>
                    <div class="photo-upload-area" onclick="triggerFileInput()">
                        <span style="font-size: 24px;">üì∑</span>
                        <div style="font-size: 12px; color: #666;">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</div>
                    </div>
                    <input type="file" id="file-input" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(event)">
                    <div id="photo-preview" class="photo-preview-grid"></div>
                </div>
                
                <button class="btn" onclick="addToCartFromModal()">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
            </div>
        </div>
        
        <!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é (–∫–∞–∫ –≤ UNICORN) -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showView('catalog')">
                <span class="nav-icon">üõçÔ∏è</span>
                <span>–ö–∞—Ç–∞–ª–æ–≥</span>
            </button>
            <button class="nav-item" onclick="showView('cart')">
                <span class="nav-icon">üõí</span>
                <span>–ö–æ—Ä–∑–∏–Ω–∞ <span id="cart-badge">0</span></span>
            </button>
            <button class="nav-item" onclick="showView('orders')">
                <span class="nav-icon">üì¶</span>
                <span>–ó–∞–∫–∞–∑—ã</span>
            </button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        let user = tg.initDataUnsafe?.user || { 
            id: Math.floor(Math.random() * 1000000), 
            first_name: '–ì–æ—Å—Ç—å',
            username: 'guest'
        };

        const API_URL = 'https://maxkom.pythonanywhere.com/api';
        const ADMIN_CONTACT = 'https://t.me/closersmanager';

        // ========== –ö–ê–¢–ê–õ–û–ì ==========
        const CATALOG = [
            { id: 1, name: 'Nike Air Jordan 1 High OG', price: '195$', image: 'AJ1', baseQuery: 'Air Jordan 1 High OG' },
            { id: 2, name: 'Essentials Fear of God Hoodie', price: '110$', image: 'FOG', baseQuery: 'Essentials Fear of God Hoodie' },
            { id: 3, name: 'Stussy 8 Ball Zip Hoodie', price: '145$', image: 'STUSSY', baseQuery: 'Stussy 8 Ball Zip Hoodie' },
            { id: 4, name: 'New Balance 990v6 Grey', price: '200$', image: 'NB990', baseQuery: 'New Balance 990v6' },
            { id: 5, name: 'Adidas Samba OG', price: '100$', image: 'SAMBA', baseQuery: 'Adidas Samba OG' },
            { id: 6, name: 'Supreme Box Logo Hoodie', price: '398$', image: 'SUPREME', baseQuery: 'Supreme Box Logo Hoodie' },
            { id: 7, name: 'Palm Angels Track Pants', price: '295$', image: 'PALM', baseQuery: 'Palm Angels Track Pants' },
            { id: 8, name: 'Ralph Lauren Bear Sweater', price: '185$', image: 'POLO', baseQuery: 'Ralph Lauren Bear Sweater' },
            { id: 9, name: 'Carhartt WIP Detroit Jacket', price: '260$', image: 'CARHARTT', baseQuery: 'Carhartt WIP Detroit Jacket' },
            { id: 10, name: 'Gallery Dept. Los Angeles Tee', price: '175$', image: 'GALLERY', baseQuery: 'Gallery Dept. Tee' },
            { id: 11, name: 'The North Face 1996 Nuptse', price: '320$', image: 'TNF', baseQuery: 'The North Face 1996 Nuptse' },
            { id: 12, name: 'Arc\'teryx Beta AR Jacket', price: '599$', image: 'ARCTERYX', baseQuery: 'Arc\'teryx Beta AR' }
        ];

        // ========== –ö–û–†–ó–ò–ù–ê ==========
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        
        // ========== –§–û–¢–û (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ) ==========
        let currentModalPhotos = [];
        let currentModalProduct = null;
        let lastOrderTime = 0;
        const SPAM_DELAY = 30000;

        // ========== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ö–ê–¢–ê–õ–û–ì–ê ==========
        function renderCatalog() {
            let html = '<div class="catalog-grid">';
            
            CATALOG.forEach(product => {
                const inCart = cart.some(item => item.catalogId === product.id);
                const cartCount = cart.filter(item => item.catalogId === product.id).length;
                
                html += `
                    <div class="product-card ${inCart ? 'in-cart' : ''}" onclick="openProductModal(${product.id})">
                        <div class="product-image">${product.image}</div>
                        <div class="product-title">${product.name}</div>
                        <div class="product-price">${product.price}</div>
                        ${cartCount > 0 ? `<div class="cart-badge-mini">${cartCount}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('catalog-view').innerHTML = html;
        }

        // ========== –û–¢–ö–†–´–¢–¨ –ú–û–î–ê–õ–ö–£ ==========
        window.openProductModal = function(productId) {
            const product = CATALOG.find(p => p.id === productId);
            if (!product) return;
            
            currentModalProduct = product;
            currentModalPhotos = [];
            
            document.getElementById('modal-product').innerHTML = `
                <div style="font-weight: 600;">${product.name}</div>
                <div style="color: #666; font-size: 13px; margin-top: 4px;">${product.price}</div>
            `;
            
            document.getElementById('modal-query').value = product.baseQuery;
            document.getElementById('modal-size').value = '';
            document.getElementById('modal-color').value = '';
            document.getElementById('photo-preview').innerHTML = '';
            
            document.getElementById('product-modal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('product-modal').classList.remove('active');
            currentModalProduct = null;
            currentModalPhotos = [];
        };

        // ========== –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û ==========
        window.triggerFileInput = function() {
            document.getElementById('file-input').click();
        };

        window.handleFileSelect = function(event) {
            const files = Array.from(event.target.files);
            if (currentModalPhotos.length + files.length > 5) {
                alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 —Ñ–æ—Ç–æ');
                return;
            }
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentModalPhotos.push(e.target.result);
                    renderPhotoPreview();
                };
                reader.readAsDataURL(file);
            });
        };

        function renderPhotoPreview() {
            let html = '';
            currentModalPhotos.forEach((photo, index) => {
                html += `
                    <div class="photo-preview-item">
                        <img src="${photo}" alt="preview">
                        <button class="photo-remove" onclick="removePhoto(${index})">√ó</button>
                    </div>
                `;
            });
            document.getElementById('photo-preview').innerHTML = html;
        }

        window.removePhoto = function(index) {
            currentModalPhotos.splice(index, 1);
            renderPhotoPreview();
        };

        // ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ö–û–†–ó–ò–ù–£ ==========
        window.addToCartFromModal = function() {
            if (!currentModalProduct) return;
            
            const size = document.getElementById('modal-size').value;
            const color = document.getElementById('modal-color').value;
            const query = document.getElementById('modal-query').value || currentModalProduct.baseQuery;
            
            cart.push({
                catalogId: currentModalProduct.id,
                name: currentModalProduct.name,
                query: query,
                size: size,
                color: color,
                photos: currentModalPhotos.slice(), // –∫–æ–ø–∏—Ä—É–µ–º —Ñ–æ—Ç–æ
                price: currentModalProduct.price,
                addedAt: new Date().toISOString()
            });
            
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCatalog();
            updateCartBadge();
            closeModal();
            tg.showAlert(`‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`);
        };

        // ========== –ö–û–†–ó–ò–ù–ê ==========
        function renderCart() {
            if (cart.length === 0) {
                document.getElementById('cart-view').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">–ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>';
                return;
            }
            
            let html = '<div class="cart-container">';
            
            cart.forEach((item, index) => {
                html += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-title">${item.name}</div>
                            <div class="cart-item-details">
                                üîç ${item.query.substring(0, 40)}${item.query.length > 40 ? '...' : ''}
                                ${item.size ? `\nüìè ${item.size}` : ''}
                                ${item.color ? `\nüé® ${item.color}` : ''}
                                ${item.photos && item.photos.length ? `\nüì∏ ${item.photos.length} —Ñ–æ—Ç–æ` : ''}
                            </div>
                        </div>
                        <button class="cart-item-remove" onclick="removeFromCart(${index})">√ó</button>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 16px;">
                    <button class="btn" onclick="submitOrder()" id="submit-order-btn">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
                    <div id="order-timer" style="text-align: center; font-size: 12px; color: #999;"></div>
                </div>
            </div>`;
            
            document.getElementById('cart-view').innerHTML = html;
        }

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
            renderCatalog();
            updateCartBadge();
        };

        function updateCartBadge() {
            document.getElementById('cart-badge').textContent = cart.length;
        }

        // ========== –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ==========
        window.submitOrder = async function() {
            if (cart.length === 0) {
                tg.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }
            
            const now = Date.now();
            if (now - lastOrderTime < SPAM_DELAY) {
                const remaining = Math.ceil((SPAM_DELAY - (now - lastOrderTime)) / 1000);
                tg.showAlert(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${remaining} —Å–µ–∫.`);
                return;
            }
            
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true;
            btn.textContent = '–û–¢–ü–†–ê–í–ö–ê...';
            
            try {
                const orderData = {
                    userId: String(user.id),
                    userName: user.first_name || '–ì–æ—Å—Ç—å',
                    username: user.username || 'guest',
                    items: cart.map(item => ({
                        name: item.name,
                        query: item.query,
                        size: item.size || '',
                        color: item.color || '',
                        photos: item.photos || []  // —Ñ–æ—Ç–æ –≤ base64
                    })),
                    totalItems: cart.length
                };
                
                let response = await fetch(API_URL + '/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                let result = await response.json();
                
                if (result.success) {
                    lastOrderTime = Date.now();
                    
                    tg.showPopup({
                        title: '‚úÖ –ó–ê–ö–ê–ó –û–§–û–†–ú–õ–ï–ù',
                        message: `–ó–∞–∫–∞–∑ #${result.orderId}\n\n–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º: @closersmanager`,
                        buttons: [
                            { type: 'default', text: '‚úâÔ∏è –ù–ê–ü–ò–°–ê–¢–¨ –ê–î–ú–ò–ù–£', url: ADMIN_CONTACT },
                            { type: 'ok', text: '–û–ö' }
                        ]
                    });
                    
                    cart = [];
                    localStorage.removeItem('cart');
                    renderCart();
                    renderCatalog();
                    updateCartBadge();
                    await loadOrders();
                    showView('orders');
                }
            } catch (error) {
                console.error(error);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                btn.disabled = false;
                btn.textContent = '–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó';
            }
        };

        // ========== –ó–ê–ì–†–£–ó–ö–ê –ó–ê–ö–ê–ó–û–í (–° –¢–†–ï–ö–ò–ù–ì–û–ú) ==========
        async function loadOrders() {
            try {
                let response = await fetch(API_URL + '/user-orders?userId=' + user.id);
                let orders = await response.json();
                
                if (!orders || orders.length === 0) {
                    document.getElementById('orders-view').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">–£ –í–ê–° –ü–û–ö–ê –ù–ï–¢ –ó–ê–ö–ê–ó–û–í</div>';
                    return;
                }
                
                let html = '<div class="orders-list">';
                
                orders.forEach(order => {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞
                    const statuses = [
                        { key: 'pending', label: '–û–∂–∏–¥–∞–Ω–∏–µ', date: order.date },
                        { key: 'searching', label: '–ü–æ–∏—Å–∫ –Ω–∞ POIZON', date: order.searchDate || null },
                        { key: 'ordered', label: '–ó–∞–∫–∞–∑–∞–Ω–æ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞', date: order.orderedDate || null },
                        { key: 'shipping', label: '–í –ø—É—Ç–∏ –≤ –†–æ—Å—Å–∏—é', date: order.shippingDate || null },
                        { key: 'stock', label: '–ù–∞ —Å–∫–ª–∞–¥–µ', date: order.stockDate || null },
                        { key: 'delivery', label: '–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –¥–æ—Å—Ç–∞–≤–∫—É', date: order.deliveryDate || null },
                        { key: 'completed', label: '–ü–æ–ª—É—á–µ–Ω', date: order.completedDate || null }
                    ];
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
                    const currentStatus = order.status || 'pending';
                    let currentIndex = statuses.findIndex(s => s.key === currentStatus);
                    if (currentIndex === -1) currentIndex = 0;
                    
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <span class="order-id">–ó–ê–ö–ê–ó #${order.id}</span>
                                <span class="order-status-badge">${statuses[currentIndex].label}</span>
                            </div>
                            
                            <div class="status-timeline">
                                ${statuses.map((status, idx) => {
                                    let statusClass = '';
                                    if (idx < currentIndex) statusClass = 'completed';
                                    else if (idx === currentIndex) statusClass = 'active';
                                    
                                    return `
                                        <div class="status-step">
                                            <div class="status-dot ${statusClass}"></div>
                                            ${idx < statuses.length - 1 ? '<div class="status-line"></div>' : ''}
                                            <div class="status-content">
                                                <div class="status-title">${status.label}</div>
                                                ${status.date ? `<div class="status-date">${new Date(status.date).toLocaleString('ru-RU')}</div>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div style="font-size: 12px; color: #666; margin-top: 12px;">
                                –¢–æ–≤–∞—Ä–æ–≤: ${order.items ? order.items.length : 1}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('orders-view').innerHTML = html;
            } catch (error) {
                console.error(error);
                document.getElementById('orders-view').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò</div>';
            }
        }

        // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
        window.showView = function(view) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById('catalog-view').style.display = 'none';
            document.getElementById('cart-view').style.display = 'none';
            document.getElementById('orders-view').style.display = 'none';
            
            if (view === 'catalog') {
                document.querySelector('.nav-item').classList.add('active');
                document.getElementById('catalog-view').style.display = 'block';
                renderCatalog();
            } else if (view === 'cart') {
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                document.getElementById('cart-view').style.display = 'block';
                renderCart();
            } else if (view === 'orders') {
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                document.getElementById('orders-view').style.display = 'block';
                loadOrders();
            }
        };

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        renderCatalog();
        updateCartBadge();
        loadOrders();
    </script>
</body>
</html>
